{"version":3,"sources":["../../src/shaders/WaterDropPostFX.ts"],"names":["fragShader","WaterDropPostFX","game","name","progress","resizeMode","toRatio","amplitude","speed","setTexture","mode","texture","phaserTexture","textures","getFrame","width","height","targetTexture","glTexture","undefined","set1i","set1f","value","Phaser","Math","Clamp","renderTarget","bindTexture","bindAndDraw","Renderer","WebGL","Pipelines","PostFXPipeline"],"mappings":"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","sourcesContent":["/**\n * @author       Richard Davey <rich@photonstorm.com>\n * @author       Paweł Płóciennik\n * @copyright    2021 Photon Storm Ltd.\n */\n\nimport Phaser from 'phaser';\n\nconst fragShader = `\n#define SHADER_NAME WATERDROP_FS\n\nprecision mediump float;\n\nuniform sampler2D uMainSampler;\nuniform sampler2D uMainSampler2;\n\nuniform int resizeMode;\nuniform float progress;\nuniform float fromRatio;\nuniform float toRatio;\n\nvarying vec2 outFragCoord;\n\n//  Transition specific\nuniform float amplitude;\nuniform float speed;\n\nvec4 getFromColor (vec2 uv)\n{\n    return texture2D(uMainSampler, uv);\n}\n\nvec4 getToColor (vec2 uv)\n{\n    if (resizeMode == 2)\n    {\n        //  cover\n        return texture2D(uMainSampler2, 0.5 + (vec2(uv.x, 1.0 - uv.y) - 0.5) * vec2(min(fromRatio / toRatio, 1.0), min((toRatio / fromRatio), 1.0)));\n    }\n    else if (resizeMode == 1)\n    {\n        //  contain\n        return texture2D(uMainSampler2, 0.5 + (vec2(uv.x, 1.0 - uv.y) - 0.5) * vec2(max(fromRatio / toRatio, 1.0), max((toRatio / fromRatio), 1.0)));\n    }\n    else\n    {\n        //  stretch\n        return texture2D(uMainSampler2, vec2(uv.x, 1.0 - uv.y));\n    }\n}\n\n// Transition Author: Paweł Płóciennik\n// Transition License: MIT\n\nvec4 transition (vec2 p)\n{\n    vec2 dir = p - vec2(0.5);\n\n    float dist = length(dir);\n\n    if (dist > progress)\n    {\n        return mix(getFromColor(p), getToColor(p), progress);\n    }\n    else\n    {\n        vec2 offset = dir * sin(dist * amplitude - progress * speed);\n\n        return mix(getFromColor(p + offset), getToColor(p), progress);\n    }\n}\n    \nvoid main ()\n{\n    vec2 uv = outFragCoord;\n\n    gl_FragColor = transition(uv);\n}\n`;\n\nexport class WaterDropPostFX extends Phaser.Renderer.WebGL.Pipelines.PostFXPipeline\n{\n    /**\n     * The progress of the transition effect. From 0 to 1.\n     *\n     * @type {number}\n     * @memberof WaterDropPostFX\n     */\n    progress: number;\n\n    /**\n     * The WebGL Texture being transitioned to.\n     *\n     * @type {WebGLTexture}\n     * @memberof WaterDropPostFX\n     */\n    targetTexture: WebGLTexture;\n\n    /**\n     * The resize mode to be used for the target texture.\n     * \n     * Can be either 0, 1 or 2, for stretch, contain and cover modes respectively.\n     * \n     * The default is 'contain'.\n     * \n     * Set via the `setResizeMode` method.\n     *\n     * @type {number}\n     * @memberof WaterDropPostFX\n     */\n    resizeMode: number;\n\n    /**\n     * The ratio of the target texture (width / height).\n     * \n     * This is set automatically in the `setTexture` method.\n     *\n     * @type {number}\n     * @memberof WaterDropPostFX\n     */\n    toRatio: number;\n\n    /**\n     * The amplitude of the effect.\n     * \n     * This controls how many 'ripples' there are.\n     * \n     * @type {number}\n     * @memberof WaterDropPostFX\n     */\n    amplitude: number;\n\n    /**\n     * The speed of the effect.\n     * \n     * This controls how fast the ripples spread from the center.\n     * \n     * @type {number}\n     * @memberof WaterDropPostFX\n     */\n    speed: number;\n\n    /**\n     * The Water Drop Post FX is an effect that allows you to transition\n     * between two objects via an effect that looks like water rippling\n     * out from the surface. You can control the amplitude and speed of\n     * the ripple.\n     * \n     * The source image comes from the Game Object to which the FX is applied,\n     * which can be any Game Object that supports post pipelines, such as a\n     * Sprite, Rope or Layer. You can also transition Cameras and even entire\n     * Scenes. Please see the examples and class docs for further details.\n     * \n     * @param {Phaser.Game} game\n     * @memberof WaterDropPostFX\n     */\n    constructor (game: Phaser.Game)\n    {\n        super({\n            game,\n            name: 'WaterDropPostFX',\n            fragShader\n        });\n\n        this.progress = 0;\n        this.resizeMode = 1;\n        this.toRatio = 0;\n\n        this.amplitude = 30;\n        this.speed = 30;\n    }\n\n    /**\n     * @ignore\n     */\n    onBoot (): void\n    {\n        this.setTexture();\n    }\n\n    /**\n     * Set the resize mode of the target texture.\n     * \n     * Can be either:\n     * \n     * 0 - Stretch. The target texture is stretched to the size of the source texture.\n     * 1 - Contain. The target texture is resized to fit the source texture. This is the default.\n     * 2 - Cover. The target texture is resized to cover the source texture.\n     * \n     * If the source and target textures are the same size, then use a resize mode of zero\n     * for speed.\n     *\n     * @param {number} [mode=1] - The Resize Mode. Either 0, 1 or 2.\n     * @returns {this}\n     * @memberof WaterDropPostFX\n     */\n    setResizeMode (mode: number = 1): this\n    {\n        this.resizeMode = mode;\n\n        return this;\n    }\n\n    /**\n     * Set the texture to be transitioned to.\n     * \n     * The texture must be already loaded and available from the Texture Manager.\n     * \n     * You can optionally also set the resize mode. This can be either:\n     * \n     * 0 - Stretch. The target texture is stretched to the size of the source texture.\n     * 1 - Contain. The target texture is resized to fit the source texture. This is the default.\n     * 2 - Cover. The target texture is resized to cover the source texture.\n     * \n     * If the source and target textures are the same size, then use a resize mode of zero\n     * for speed.\n     *\n     * @param {string} [texture='__DEFAULT'] - The key of the texture to use.\n     * @param {number} [mode] - The Resize Mode. Either 0, 1 or 2.\n     * @returns {this}\n     * @memberof WaterDropPostFX\n     */\n    setTexture (texture: string = '__DEFAULT', resizeMode?: number): this\n    {\n        let phaserTexture = this.game.textures.getFrame(texture);\n\n        if (!phaserTexture)\n        {\n            phaserTexture = this.game.textures.getFrame('__DEFAULT');\n        }\n\n        this.toRatio = phaserTexture.width / phaserTexture.height;\n\n        this.targetTexture = phaserTexture.glTexture;\n\n        if (resizeMode !== undefined)\n        {\n            this.resizeMode = resizeMode;\n        }\n\n        this.set1i('uMainSampler2', 1);\n        this.set1f('toRatio', this.toRatio);\n\n        return this;\n    }\n\n    /**\n     * Sets the progress of this effect.\n     * \n     * Progress is given as a value between 0 and 1.\n     * \n     * You can call this method at any point, or modify the `progress` property\n     * directly for the same result. This can be done via tweens, Scene transitions,\n     * Loader progress updates or any other system.\n     *\n     * @param {number} [value=0] - The progress of the effect. A value between 0 and 1.\n     * @returns {this}\n     * @memberof WaterDropPostFX\n     */\n    setProgress (value: number = 0): this\n    {\n        this.progress = Phaser.Math.Clamp(value, 0, 1);\n\n        return this;\n    }\n\n    /**\n     * Sets the amplitude of the Water Drop effect.\n     * \n     * This controls the number of ripples.\n     * \n     * @param {number} [value=30] - The amplitude.\n     * @returns {this}\n     * @memberof WaterDropPostFX\n     */\n    setAmplitude (value: number = 30): this\n    {\n        this.amplitude = value;\n\n        return this;\n    }\n\n    /**\n     * Sets the speed of the Water Drop effect.\n     * \n     * This controls how fast the ripples spread from the center.\n     * \n     * @param {number} [value=30] - The amplitude.\n     * @returns {this}\n     * @memberof WaterDropPostFX\n     */\n    setSpeed (value: number = 30): this\n    {\n        this.speed = value;\n\n        return this;\n    }\n\n    /**\n     * @ignore\n     */\n    onPreRender (): void\n    {\n        this.set1f('progress', this.progress);\n        this.set1i('resizeMode', this.resizeMode);\n        this.set1f('amplitude', this.amplitude);\n        this.set1f('speed', this.speed);\n    }\n\n    /**\n     * @ignore\n     */\n    onDraw (renderTarget: Phaser.Renderer.WebGL.RenderTarget): void\n    {\n        this.set1f('fromRatio', renderTarget.width / renderTarget.height);\n\n        this.bindTexture(this.targetTexture, 1);\n\n        this.bindAndDraw(renderTarget);\n    }\n}\n"],"file":"WaterDropPostFX.js"}